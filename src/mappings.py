#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CodeBridge - 映射管理器
"""

import json
from pathlib import Path
from typing import Dict, List, Tuple, Set, Optional
import logging


class MappingManager:
    """
    映射管理器
    
    負責管理簡繁轉換映射表，包括內建映射和自定義映射
    """
    
    def __init__(self):
        """初始化映射管理器"""
        self.logger = logging.getLogger('CodeBridge.MappingManager')
        self._builtin_mappings = self._load_builtin_mappings()
        self._custom_mappings = {}
        self._mappings_updated = False
        
    def _load_builtin_mappings(self) -> Dict[str, str]:
        """載入內建映射表"""
        # 這裡是我們之前開發的完整映射表
        return {
            # ============ 基本字符轉換 ============
            # A-E
            '爱': '愛', '安': '安', '岸': '岸', '按': '按', '暗': '暗',
            '昂': '昂', '袄': '襖', '奥': '奧', '坝': '壩', '把': '把',
            '坏': '壞', '摆': '擺', '败': '敗', '拜': '拜', '班': '班',
            '般': '般', '颁': '頒', '版': '版', '板': '板', '办': '辦',
            '绑': '綁', '榜': '榜', '傍': '傍', '包': '包', '宝': '寶',
            '保': '保', '报': '報', '抱': '抱', '暴': '暴', '杯': '杯',
            '悲': '悲', '北': '北', '备': '備', '背': '背', '被': '被',
            '本': '本', '笨': '笨', '比': '比', '币': '幣', '必': '必',
            '毕': '畢', '闭': '閉', '边': '邊', '编': '編', '便': '便',
            '变': '變', '遍': '遍', '标': '標', '表': '表', '别': '別',
            '并': '並', '病': '病', '拨': '撥', '播': '播', '补': '補',
            '不': '不', '布': '布', '步': '步', '部': '部', '采': '採',
            '彩': '彩', '参': '參', '仓': '倉', '苍': '蒼', '操': '操',
            '草': '草', '册': '冊', '测': '測', '层': '層', '曾': '曾',
            '差': '差', '产': '產', '长': '長', '场': '場', '常': '常',
            '厂': '廠', '畅': '暢', '唱': '唱', '车': '車', '彻': '徹',
            '尘': '塵', '沉': '沉', '陈': '陳', '晨': '晨', '称': '稱',
            '城': '城', '乘': '乘', '程': '程', '惩': '懲', '迟': '遲',
            '持': '持', '冲': '沖', '虫': '蟲', '抽': '抽', '丑': '醜',
            '出': '出', '初': '初', '除': '除', '处': '處', '传': '傳',
            '船': '船', '创': '創', '窗': '窗', '床': '床', '串': '串',
            '春': '春', '纯': '純', '词': '詞', '此': '此', '次': '次',
            '从': '從', '粗': '粗', '促': '促', '醋': '醋', '存': '存',
            '错': '錯', '达': '達', '答': '答', '打': '打', '大': '大',
            '带': '帶', '待': '待', '担': '擔', '单': '單', '胆': '膽',
            '但': '但', '淡': '淡', '蛋': '蛋', '当': '當', '档': '檔',
            '导': '導', '到': '到', '道': '道', '得': '得', '的': '的',
            '灯': '燈', '等': '等', '低': '低', '底': '底', '地': '地',
            '第': '第', '点': '點', '电': '電', '店': '店', '钓': '釣',
            '调': '調', '丢': '丟', '东': '東', '冬': '冬', '懂': '懂',
            '动': '動', '冻': '凍', '独': '獨', '读': '讀', '堵': '堵',
            '赌': '賭', '度': '度', '短': '短', '断': '斷', '段': '段',
            '对': '對', '队': '隊', '吨': '噸', '多': '多', '夺': '奪',
            '额': '額', '恶': '惡', '饿': '餓', '儿': '兒', '而': '而',
            '耳': '耳', '二': '二', '发': '發', '乏': '乏', '法': '法',
            '番': '番', '烦': '煩', '反': '反', '范': '範', '饭': '飯',
            '方': '方', '房': '房', '防': '防', '访': '訪', '纺': '紡',
            '放': '放', '飞': '飛', '非': '非', '肥': '肥', '费': '費',
            '分': '分', '份': '份', '丰': '豐', '风': '風', '封': '封',
            '冯': '馮', '逢': '逢', '奉': '奉', '否': '否', '夫': '夫',
            '服': '服', '浮': '浮', '福': '福', '抚': '撫', '府': '府',
            '复': '復', '负': '負', '富': '富', '妇': '婦', '该': '該',
            '改': '改', '概': '概', '干': '幹', '赶': '趕', '感': '感',
            '刚': '剛', '钢': '鋼', '高': '高', '搞': '搞', '告': '告',
            '歌': '歌', '革': '革', '格': '格', '个': '個', '给': '給',
            '根': '根', '跟': '跟', '更': '更', '工': '工', '公': '公',
            '功': '功', '供': '供', '共': '共', '够': '夠', '构': '構',
            '购': '購', '古': '古', '股': '股', '骨': '骨', '故': '故',
            '顾': '顧', '固': '固', '关': '關', '观': '觀', '官': '官',
            '管': '管', '馆': '館', '光': '光', '广': '廣', '归': '歸',
            '规': '規', '贵': '貴', '国': '國', '果': '果', '过': '過',
            '还': '還', '孩': '孩', '海': '海', '害': '害', '含': '含',
            '汉': '漢', '号': '號', '好': '好', '合': '合', '何': '何',
            '和': '和', '河': '河', '黑': '黑', '很': '很', '红': '紅',
            '后': '後', '厚': '厚', '候': '候', '呼': '呼', '虎': '虎',
            '户': '戶', '护': '護', '花': '花', '华': '華', '画': '畫',
            '话': '話', '怀': '懷', '坏': '壞', '欢': '歡', '环': '環',
            '换': '換', '黄': '黃', '回': '回', '会': '會', '婚': '婚',
            '活': '活', '火': '火', '货': '貨', '获': '獲', '机': '機',
            '鸡': '雞', '积': '積', '基': '基', '极': '極', '级': '級',
            '急': '急', '集': '集', '几': '幾', '己': '己', '计': '計',
            '记': '記', '既': '既', '继': '繼', '际': '際', '加': '加',
            '家': '家', '假': '假', '价': '價', '驾': '駕', '架': '架',
            '间': '間', '简': '簡', '见': '見', '建': '建', '健': '健',
            '将': '將', '江': '江', '讲': '講', '交': '交', '脚': '腳',
            '角': '角', '叫': '叫', '教': '教', '接': '接', '街': '街',
            '节': '節', '结': '結', '解': '解', '姐': '姐', '介': '介',
            '界': '界', '借': '借', '今': '今', '金': '金', '仅': '僅',
            '紧': '緊', '进': '進', '近': '近', '经': '經', '京': '京',
            '精': '精', '景': '景', '静': '靜', '究': '究', '就': '就',
            '举': '舉', '具': '具', '据': '據', '剧': '劇', '决': '決',
            '绝': '絕', '军': '軍', '开': '開', '看': '看', '康': '康',
            '考': '考', '科': '科', '可': '可', '课': '課', '空': '空',
            '控': '控', '口': '口', '库': '庫', '快': '快', '宽': '寬',
            '况': '況', '扩': '擴', '垃': '垃', '拉': '拉', '来': '來',
            '蓝': '藍', '老': '老', '乐': '樂', '了': '了', '类': '類',
            '冷': '冷', '离': '離', '里': '裡', '礼': '禮', '理': '理',
            '历': '歷', '立': '立', '利': '利', '连': '連', '联': '聯',
            '脸': '臉', '练': '練', '量': '量', '亮': '亮', '两': '兩',
            '辆': '輛', '了': '了', '列': '列', '林': '林', '临': '臨',
            '领': '領', '另': '另', '留': '留', '流': '流', '六': '六',
            '龙': '龍', '楼': '樓', '路': '路', '乱': '亂', '论': '論',
            '落': '落', '妈': '媽', '马': '馬', '买': '買', '卖': '賣',
            '满': '滿', '慢': '慢', '忙': '忙', '猫': '貓', '么': '麼',
            '没': '沒', '美': '美', '门': '門', '们': '們', '梦': '夢',
            '迷': '迷', '米': '米', '密': '密', '面': '面', '民': '民',
            '名': '名', '明': '明', '模': '模', '母': '母', '目': '目',
            '拿': '拿', '哪': '哪', '那': '那', '男': '男', '南': '南',
            '难': '難', '脑': '腦', '内': '內', '能': '能', '你': '你',
            '年': '年', '念': '念', '娘': '娘', '鸟': '鳥', '您': '您',
            '农': '農', '女': '女', '暖': '暖', '欧': '歐', '爬': '爬',
            '怕': '怕', '拍': '拍', '排': '排', '盘': '盤', '判': '判',
            '旁': '旁', '跑': '跑', '配': '配', '朋': '朋', '批': '批',
            '片': '片', '票': '票', '拼': '拼', '平': '平', '评': '評',
            '破': '破', '七': '七', '期': '期', '其': '其', '奇': '奇',
            '骑': '騎', '起': '起', '气': '氣', '汽': '汽', '千': '千',
            '前': '前', '钱': '錢', '强': '強', '桥': '橋', '切': '切',
            '亲': '親', '轻': '輕', '清': '清', '情': '情', '请': '請',
            '庆': '慶', '穷': '窮', '秋': '秋', '求': '求', '区': '區',
            '取': '取', '去': '去', '权': '權', '全': '全', '却': '卻',
            '确': '確', '让': '讓', '热': '熱', '人': '人', '认': '認',
            '任': '任', '日': '日', '容': '容', '如': '如', '入': '入',
            '三': '三', '色': '色', '杀': '殺', '山': '山', '善': '善',
            '商': '商', '上': '上', '少': '少', '设': '設', '深': '深',
            '身': '身', '什': '什', '生': '生', '声': '聲', '省': '省',
            '十': '十', '时': '時', '实': '實', '识': '識', '史': '史',
            '始': '始', '使': '使', '是': '是', '事': '事', '市': '市',
            '室': '室', '试': '試', '收': '收', '手': '手', '首': '首',
            '受': '受', '书': '書', '数': '數', '树': '樹', '双': '雙',
            '水': '水', '睡': '睡', '说': '說', '死': '死', '四': '四',
            '送': '送', '苏': '蘇', '算': '算', '随': '隨', '岁': '歲',
            '所': '所', '他': '他', '她': '她', '它': '它', '台': '臺',
            '太': '太', '谈': '談', '弹': '彈', '汤': '湯', '糖': '糖',
            '躺': '躺', '讨': '討', '套': '套', '特': '特', '疼': '疼',
            '提': '提', '题': '題', '体': '體', '天': '天', '田': '田',
            '条': '條', '跳': '跳', '铁': '鐵', '听': '聽', '停': '停',
            '通': '通', '同': '同', '头': '頭', '投': '投', '图': '圖',
            '土': '土', '团': '團', '推': '推', '脱': '脫', '外': '外',
            '弯': '彎', '完': '完', '玩': '玩', '晚': '晚', '万': '萬',
            '王': '王', '网': '網', '往': '往', '忘': '忘', '为': '為',
            '围': '圍', '位': '位', '味': '味', '温': '溫', '文': '文',
            '问': '問', '我': '我', '无': '無', '五': '五', '午': '午',
            '舞': '舞', '务': '務', '物': '物', '西': '西', '希': '希',
            '息': '息', '习': '習', '洗': '洗', '喜': '喜', '细': '細',
            '下': '下', '夏': '夏', '先': '先', '现': '現', '线': '線',
            '限': '限', '相': '相', '想': '想', '响': '響', '向': '向',
            '像': '像', '消': '消', '小': '小', '笑': '笑', '效': '效',
            '些': '些', '写': '寫', '谢': '謝', '新': '新', '心': '心',
            '信': '信', '星': '星', '行': '行', '醒': '醒', '兴': '興',
            '许': '許', '续': '續', '选': '選', '学': '學', '雪': '雪',
            '血': '血', '压': '壓', '亚': '亞', '烟': '煙', '严': '嚴',
            '研': '研', '眼': '眼', '演': '演', '验': '驗', '羊': '羊',
            '样': '樣', '养': '養', '要': '要', '药': '藥', '爷': '爺',
            '也': '也', '叶': '葉', '夜': '夜', '一': '一', '医': '醫',
            '已': '已', '以': '以', '艺': '藝', '议': '議', '音': '音',
            '因': '因', '银': '銀', '应': '應', '英': '英', '营': '營',
            '影': '影', '用': '用', '优': '優', '由': '由', '游': '遊',
            '友': '友', '有': '有', '又': '又', '右': '右', '鱼': '魚',
            '于': '於', '语': '語', '雨': '雨', '预': '預', '员': '員',
            '园': '園', '远': '遠', '愿': '願', '约': '約', '月': '月',
            '越': '越', '云': '雲', '运': '運', '在': '在', '早': '早',
            '造': '造', '则': '則', '怎': '怎', '增': '增', '展': '展',
            '战': '戰', '站': '站', '张': '張', '长': '長', '招': '招',
            '找': '找', '照': '照', '着': '著', '真': '真', '正': '正',
            '证': '證', '知': '知', '只': '只', '直': '直', '值': '值',
            '职': '職', '止': '止', '中': '中', '种': '種', '重': '重',
            '周': '週', '主': '主', '住': '住', '注': '注', '专': '專',
            '转': '轉', '装': '裝', '状': '狀', '准': '準', '桌': '桌',
            '自': '自', '总': '總', '走': '走', '组': '組', '嘴': '嘴',
            '最': '最', '左': '左', '作': '作', '做': '做', '坐': '坐',

            # ============ 常用詞彙轉換 ============
            # 科技類
            '数据': '數據', '网络': '網絡', '软件': '軟件', '计算': '計算',
            '程序': '程序', '编程': '編程', '开发': '開發', '设计': '設計',
            '项目': '項目', '服务': '服務', '系统': '系統', '应用': '應用',
            '技术': '技術', '解决': '解決', '问题': '問題', '处理': '處理',
            '显示': '顯示', '输入': '輸入', '输出': '輸出', '设置': '設置',
            '连接': '連接', '访问': '訪問', '权限': '權限', '备份': '備份',
            '恢复': '恢復', '更新': '更新', '升级': '升級', '优化': '優化',
            '测试': '測試', '调试': '調試', '错误': '錯誤', '修复': '修復',
            '维护': '維護', '监控': '監控', '统计': '統計', '查询': '查詢',
            '过滤': '過濾', '导入': '導入', '导出': '導出', '传输': '傳輸',
            '压缩': '壓縮', '认证': '認證', '授权': '授權', '登录': '登錄',
            '注册': '註冊', '用户': '用戶', '账户': '賬戶', '密码': '密碼',
            '会话': '會話', '缓存': '緩存', '临时': '臨時', '文档': '文檔',
            '内容': '內容', '类型': '類型', '结构': '結構', '组织': '組織',
            '标签': '標籤', '分类': '分類', '链接': '鏈接', '路径': '路徑',
            '协议': '協議', '标准': '標準', '规范': '規範', '模块': '模塊',
            '组件': '組件', '扩展': '擴展', '模板': '模板', '样式': '樣式',
            '主题': '主題', '布局': '佈局', '菜单': '菜單', '按钮': '按鈕',
            '图标': '圖標', '图片': '圖片', '图像': '圖像', '视频': '視頻',
            '音频': '音頻', '媒体': '媒體', '资源': '資源', '字体': '字體',
            '颜色': '顏色', '边距': '邊距', '边框': '邊框', '阴影': '陰影',
            '滚动': '滾動', '点击': '點擊', '双击': '雙擊', '悬停': '懸停',
            '选择': '選擇', '复制': '複製', '粘贴': '貼上', '撤销': '撤銷',
            '确认': '確認', '删除': '刪除', '开始': '開始', '继续': '繼續',

            # ============ 現代開發術語 ============
            # 人工智慧與機器學習
            '人工智能': '人工智慧', '机器学习': '機器學習', '深度学习': '深度學習',
            '神经网络': '神經網路', '卷积神经网络': '卷積神經網路',
            '循环神经网络': '循環神經網路', '生成对抗网络': '生成對抗網路',
            '自然语言处理': '自然語言處理', '计算机视觉': '電腦視覺',
            '语音识别': '語音辨識', '图像识别': '影像辨識', '模式识别': '模式辨識',
            '特征工程': '特徵工程', '特征选择': '特徵選擇', '特征提取': '特徵擷取',
            '数据预处理': '資料前處理', '数据清洗': '資料清理', '数据标注': '資料標註',
            '训练集': '訓練集', '测试集': '測試集', '验证集': '驗證集', '交叉验证': '交叉驗證',
            '过拟合': '過度擬合', '欠拟合': '擬合不足', '正则化': '正規化',

            # 雲端與DevOps
            '云计算': '雲端運算', '云原生': '雲原生', '云服务': '雲端服務',
            '微服务': '微服務', '容器化': '容器化', '容器编排': '容器編排',
            '持续集成': '持續整合', '持续部署': '持續部署', '持续交付': '持續交付',
            '自动化构建': '自動化建置', '自动化测试': '自動化測試', '自动化部署': '自動化部署',
            '服务网格': '服務網格', '负载均衡': '負載平衡', '服务发现': '服務發現',
            '配置中心': '配置中心', '注册中心': '註冊中心', '监控系统': '監控系統',

            # 區塊鏈與Web3
            '区块链': '區塊鏈', '分布式账本': '分散式帳本', '智能合约': '智慧合約',
            '去中心化': '去中心化', '加密货币': '加密貨幣', '数字货币': '數位貨幣',
            '非同质化代币': '非同質化代幣', '同质化代币': '同質化代幣',

            # 物聯網與邊緣計算
            '物联网': '物聯網', '边缘计算': '邊緣運算', '智能边缘': '智慧邊緣',
            '传感器网络': '感測器網路', '设备管理': '裝置管理', '远程控制': '遠端控制',

            # 量子計算
            '量子计算': '量子運算', '量子算法': '量子演算法', '量子编程': '量子程式設計',
            '量子模拟': '量子模擬', '量子机器学习': '量子機器學習',

            # 更多開發術語
            '软件工程': '軟體工程', '需求工程': '需求工程', '软件架构': '軟體架構',
            '系统架构': '系統架構', '设计模式': '設計模式', '软件设计': '軟體設計',
            '面向对象设计': '物件導向設計', '结构化设计': '結構化設計',
            '微服务架构': '微服務架構', '单体架构': '單體架構', '分层架构': '分層架構',
            '事件驱动': '事件驅動', '数据驱动': '資料驅動', '领域驱动': '領域驅動',
            '测试驱动': '測試驅動', '行为驱动': '行為驅動',
            
            # 開發流程
            '敏捷开发': '敏捷開發', '瀑布模型': '瀑布模型', '螺旋模型': '螺旋模型',
            '增量开发': '增量開發', '迭代开发': '迭代開發', '原型开发': '原型開發',
            '用户故事': '使用者故事', '史诗故事': '史詩故事', '任务拆分': '任務拆分',
            
            # 版本控制
            '版本控制': '版本控制', '源代码管理': '原始碼管理', '分支管理': '分支管理',
            '代码仓库': '程式碼倉庫', '远程仓库': '遠端倉庫', '本地仓库': '本機倉庫',
            '代码审查': '程式碼審查', '代码合并': '程式碼合併', '代码冲突': '程式碼衝突',
            
            # 資料庫
            '关系型数据库': '關聯式資料庫', '非关系型数据库': '非關聯式資料庫',
            '内存数据库': '記憶體資料庫', '分布式数据库': '分散式資料庫',
            '数据仓库': '資料倉儲', '数据湖': '資料湖', '数据建模': '資料建模',
            
            # 前端開發
            '前端开发': '前端開發', '用户界面': '使用者介面', '用户体验': '使用者體驗',
            '响应式设计': '響應式設計', '自适应设计': '自適應設計', '移动优先': '行動優先',
            '单页应用': '單頁應用程式', '多页应用': '多頁應用程式',
            
            # 後端開發
            '后端开发': '後端開發', '服务端': '伺服器端', '应用服务器': '應用程式伺服器',
            '反向代理': '反向代理', '负载均衡器': '負載平衡器', '网关': '閘道',
            
            # 安全
            '信息安全': '資訊安全', '网络安全': '網路安全', '应用安全': '應用程式安全',
            '数据安全': '資料安全', '隐私保护': '隱私保護', '威胁建模': '威脅建模',
            
            # 特殊詞彙
            '字符': '字元', '简体': '簡體', '繁体': '繁體', '转换': '轉換',
            '检测': '檢測', '识别': '識別', '创建': '創建', '构建': '構建',
        }
    
    def get_all_mappings(self) -> Dict[str, str]:
        """獲取所有映射（內建 + 自定義）"""
        all_mappings = self._builtin_mappings.copy()
        all_mappings.update(self._custom_mappings)
        return all_mappings
    
    def load_custom_mappings(self, file_path: str) -> int:
        """
        載入自定義映射檔案
        
        Args:
            file_path: 自定義映射檔案路徑
        
        Returns:
            int: 載入的映射數量
        """
        custom_file = Path(file_path)
        if not custom_file.exists():
            raise FileNotFoundError(f"自定義映射檔案不存在: {file_path}")
        
        custom_mappings = {}
        loaded_count = 0
        
        try:
            with open(custom_file, 'r', encoding='utf-8') as f:
                for line_num, line in enumerate(f, 1):
                    line = line.strip()
                    if line and not line.startswith('#') and ':' in line:
                        try:
                            simplified, traditional = line.split(':', 1)
                            simplified = simplified.strip()
                            traditional = traditional.strip()
                            
                            if simplified and traditional:
                                custom_mappings[simplified] = traditional
                                loaded_count += 1
                        except ValueError:
                            self.logger.warning(f"第 {line_num} 行格式錯誤: {line}")
            
            self._custom_mappings.update(custom_mappings)
            self._mappings_updated = True
            self.logger.info(f"載入自定義映射: {loaded_count} 個")
            
        except Exception as e:
            self.logger.error(f"載入自定義映射失敗: {e}")
            raise
        
        return loaded_count
    
    def add_custom_mapping(self, simplified: str, traditional: str) -> bool:
        """
        添加單個自定義映射
        
        Args:
            simplified: 簡體詞
            traditional: 繁體詞
        
        Returns:
            bool: 是否添加成功
        """
        if not simplified or not traditional:
            return False
        
        self._custom_mappings[simplified] = traditional
        self._mappings_updated = True
        self.logger.debug(f"添加自定義映射: {simplified} -> {traditional}")
        return True
    
    def remove_custom_mapping(self, simplified: str) -> bool:
        """
        移除自定義映射
        
        Args:
            simplified: 要移除的簡體詞
        
        Returns:
            bool: 是否移除成功
        """
        if simplified in self._custom_mappings:
            del self._custom_mappings[simplified]
            self._mappings_updated = True
            self.logger.debug(f"移除自定義映射: {simplified}")
            return True
        return False
    
    def get_custom_mappings(self) -> Dict[str, str]:
        """獲取所有自定義映射"""
        return self._custom_mappings.copy()
    
    def get_builtin_mappings(self) -> Dict[str, str]:
        """獲取內建映射"""
        return self._builtin_mappings.copy()
    
    def save_custom_mappings(self, file_path: str) -> bool:
        """
        儲存自定義映射到檔案
        
        Args:
            file_path: 儲存路徑
        
        Returns:
            bool: 是否儲存成功
        """
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write("# 自定義簡繁轉換映射檔案\n")
                f.write("# 格式：簡體:繁體 (每行一個映射)\n\n")
                
                for simplified, traditional in sorted(self._custom_mappings.items()):
                    f.write(f"{simplified}:{traditional}\n")
            
            self.logger.info(f"儲存自定義映射到: {file_path}")
            return True
            
        except Exception as e:
            self.logger.error(f"儲存自定義映射失敗: {e}")
            return False
    
    def get_category_stats(self) -> Dict[str, int]:
        """獲取字庫分類統計"""
        all_mappings = self.get_all_mappings()
        
        categories = {
            '基本字符': 0,
            '科技開發': 0,
            '業務管理': 0,
            '系統架構': 0,
            '專業術語': 0
        }
        
        dev_keywords = {
            '编程', '开发', '测试', '部署', '架构', '设计', '框架', '库', '组件',
            '服务', '接口', 'API', '数据库', '缓存', '监控', '日志', '异常',
            '性能', '优化', '安全', '权限', '认证', '授权', '版本', '分支'
        }
        
        for simplified in all_mappings.keys():
            if len(simplified) == 1:
                categories['基本字符'] += 1
            elif any(keyword in simplified for keyword in dev_keywords):
                categories['科技開發'] += 1
            elif any(word in simplified for word in ['业务', '管理', '流程', '需求', '项目']):
                categories['業務管理'] += 1
            elif any(word in simplified for word in ['系统', '架构', '模式', '模型', '设计']):
                categories['系統架構'] += 1
            else:
                categories['專業術語'] += 1
        
        return categories
    
    def is_mappings_updated(self) -> bool:
        """檢查映射是否已更新"""
        if self._mappings_updated:
            self._mappings_updated = False
            return True
        return False
    
    def search_mappings(self, keyword: str) -> List[Tuple[str, str]]:
        """
        搜尋包含關鍵字的映射
        
        Args:
            keyword: 搜尋關鍵字
        
        Returns:
            List[Tuple[str, str]]: 符合的映射列表
        """
        all_mappings = self.get_all_mappings()
        results = []
        
        for simplified, traditional in all_mappings.items():
            if keyword in simplified or keyword in traditional:
                results.append((simplified, traditional))
        
        return results
    
    def export_mappings_json(self, file_path: str) -> bool:
        """
        匯出映射為JSON格式
        
        Args:
            file_path: 匯出檔案路徑
        
        Returns:
            bool: 是否匯出成功
        """
        try:
            all_mappings = self.get_all_mappings()
            categories = self.get_category_stats()
            
            export_data = {
                'metadata': {
                    'total_mappings': len(all_mappings),
                    'builtin_mappings': len(self._builtin_mappings),
                    'custom_mappings': len(self._custom_mappings),
                    'categories': categories
                },
                'mappings': all_mappings
            }
            
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(export_data, f, ensure_ascii=False, indent=2)
            
            self.logger.info(f"匯出映射到: {file_path}")
            return True
            
        except Exception as e:
            self.logger.error(f"匯出映射失敗: {e}")
            return False
